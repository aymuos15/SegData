# SegData Repository

This repo contains (some opinionated) code to setup common open-source datasets in the **nnU-Net format**. Only datasets that are openly accessible without request forms are included, making it easy for researchers to quickly get up and running with various segmentation datasets without worrying about data formatting or preprocessing.

## Datasets Included

Currently includes the following datasets:
- **Datset001_Cellpose**: Cell segmentation from microscopy (2D, RGB PNG)
- **Dataset002_MSLesSeg**: Multiple sclerosis lesion segmentation (3D, NIfTI)
- **Dataset003_MOTUM**: Multi-center brain tumor MRI segmentation (3D, NIfTI, 4-channel)
- **Dataset005_BUSBRA**: Breast ultrasound segmentation (2D, grayscale PNG)
- **Dataset005_KvasirSEG**: Gastrointestinal polyp segmentation (2D, RGB PNG)
- **Dataset006_BTXRD**: Bone tumor X-ray segmentation (2D, grayscale PNG)

## Repository Structure

```
SegData/
├── raw/                    # All datasets live here
│   └── Dataset###_Name/
│       ├── imagesTr/       # Training images
│       ├── labelsTr/       # Training labels/masks
│       ├── imagesTs/       # Test images
│       ├── labelsTs/       # Test labels/masks
│       ├── results/        # Analysis output from stats.py
│       ├── dataset.json    # Dataset metadata (auto-generated by setup.py)
│       ├── setup.py        # Setup script to prepare the dataset
│       ├── get.md          # Instructions for obtaining raw data
│       └── info.md         # Dataset-specific information (optional)
├── src/                    # Shared utilities
│   ├── plot.py             # Visualization (works with any dataset)
│   ├── stats.py            # Dataset statistics and analysis
│   └── verify.py           # nnU-Net format validation
└── tests/                  # Test suite
```

## Quick Start

### Setup a Dataset

```bash
cd raw/Dataset005_BUSBRA  # or any other dataset
python setup.py           # Downloads and processes the dataset
```

### Analyze and Visualize

```bash
python src/stats.py raw/Dataset005_BUSBRA     # Dataset statistics
python src/plot.py raw/Dataset005_BUSBRA       # Visualization
python src/verify.py raw/Dataset005_BUSBRA     # Validate nnU-Net format
```

**Requirements:** Install with `uv sync --all-extras`

## Testing

Comprehensive test suite ensures data quality and correctness:

```bash
# Install dependencies
uv sync

# Run all tests
uv run pytest tests/ -v

# Run specific test file
uv run pytest tests/test_setup_scripts.py -v

# Test a specific dataset
uv run pytest tests/ -k Dataset005
```

### Test Coverage

- **test_datasets.py** (24 tests): Validates every dataset has required files, valid `dataset.json`, and consistent directory structure
- **test_setup_scripts.py** (28 tests): Unit tests for dataset setup.py helper functions
  - Dataset005_BUSBRA: Image discovery, mask finding (6 tests)
  - Dataset006_BTXRD: Data root detection, CSV parsing, image lookup, COCO rasterization (18 tests)
  - Other datasets: Smoke tests verifying setup functions exist and are callable (4 tests)
- **test_src_scripts.py** (81 tests): Tests for shared `src/` utilities
  - plot.py: Metadata loading, case ID listing, image normalization, 3D slice extraction
  - stats.py: Analyzer initialization, sample counting, dimension calculation
  - verify.py: Validator initialization, dataset.json checks, format validation
  - Integration tests: Cross-script metadata consistency

## Data Format

All datasets conform to the nnU-Net data format:
- **2D datasets**: PNG files (grayscale or per-channel), binary PNG masks (0/255)
- **3D datasets**: NIfTI files (`.nii.gz`), integer label masks
- **Naming**: `{case_id}_{channel_id}.{ext}` for images, `{case_id}.{ext}` for labels
  - Example: `000_0000.png`, `001_0002.nii.gz`
- **Metadata**: `dataset.json` with dataset info, license, and citation

## Results Directory

The `results/` folder (created after running `stats.py`) contains:
- Per-case analysis JSON files with image/mask statistics
- Dataset-wide statistics: dimensions, counts, class distributions
- Summary reports and visualizations

## Contributing

Currently accepting PRs that:
- Follow the existing system structure
- Add new datasets that are openly accessible
- Improve setup scripts, tests, or documentation
- Fix bugs or optimize performance

## Development

### Install Dependencies
```bash
uv sync --all-extras  # Install all dependencies including dev/test tools
```

### Code Quality

All code is checked by:
- **ruff**: Linting and code quality
- **ruff-format**: Code formatting
- **ty-check**: Type checking

These checks run automatically as pre-commit hooks.

## License

This repository contains setup scripts for publicly available datasets. See individual dataset directories for their specific licenses and citations.
